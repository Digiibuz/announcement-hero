
// This file is automatically generated. Do not edit it directly.
import { createClient, SupabaseClient } from '@supabase/supabase-js';
// Reference Database type but use any for the time being to avoid typing errors
// import type { Database } from './types';
type Database = any; // Temporary type to avoid compilation errors

/**
 * Crée et configure un client Supabase pour le navigateur.
 * Cette version n'expose PAS les clés complètes dans le code compilé.
 * 
 * Pour les opérations sensibles, utilisez toujours les Edge Functions.
 */

// Utilise uniquement un identifiant public sans valeur sensible
// L'URL complète et la clé anon sont récupérées via une Edge Function sécurisée
const PUBLIC_PROJECT_ID = 'rdwqedmvzicerwotjseg';

// Variable pour stocker le client initialisé
let supabaseInstance: SupabaseClient<Database> | null = null;
// Flag pour suivre l'état d'initialisation
let isInitializing = false;
let initializationPromise: Promise<boolean> | null = null;
// Tracking des échecs d'initialisation
let initAttempts = 0;
const MAX_INIT_ATTEMPTS = 5;

const createSecureClient = () => {
  // Si nous avons déjà initialisé le client, retourner l'instance existante
  if (supabaseInstance) {
    return supabaseInstance;
  }

  // Création initiale avec une clé temporaire qui sera remplacée
  supabaseInstance = createClient<Database>(
    `https://${PUBLIC_PROJECT_ID}.supabase.co`,
    'public_client_placeholder',
    {
      auth: {
        persistSession: true,
        storage: localStorage,
        autoRefreshToken: true,
        detectSessionInUrl: true
      }
    }
  );
  
  return supabaseInstance;
};

// Créer le client avec des configurations sécurisées
export const supabase = createSecureClient();

// Helper function for type casting Supabase responses safely
export function typedData<T>(data: unknown): T {
  return data as T;
}

// Verrou pour éviter les initialisations concurrentes
let initLock = false;

// Initialise le client avec les vraies informations d'authentification
// Cette fonction est appelée au démarrage de l'application
export const initializeSecureClient = async (): Promise<boolean> => {
  // Système de verrouillage pour éviter les appels concurrents
  if (initLock) {
    console.log('Initialisation déjà en cours, attente...');
    return new Promise(resolve => {
      const checkInterval = setInterval(() => {
        if (!initLock) {
          clearInterval(checkInterval);
          // Vérifier si l'initialisation précédente a réussi
          resolve(supabaseInstance?.supabaseKey !== 'public_client_placeholder');
        }
      }, 100);
    });
  }

  // Si une initialisation est déjà en cours, retourner la promesse existante
  if (initializationPromise) {
    return initializationPromise;
  }
  
  // Protection contre les appels concurrents
  initLock = true;
  isInitializing = true;
  console.log('Début de l\'initialisation du client Supabase');
  
  // Incrémenter le compteur de tentatives
  initAttempts++;
  
  // Si nous avons dépassé le nombre maximum de tentatives, attendre plus longtemps
  if (initAttempts > MAX_INIT_ATTEMPTS) {
    console.warn(`Tentative d'initialisation ${initAttempts}/${MAX_INIT_ATTEMPTS} - Augmentation du délai d'attente`);
    await new Promise(resolve => setTimeout(resolve, 2000));
  }
  
  initializationPromise = new Promise(async (resolve) => {
    try {
      console.log('Appel à l\'Edge Function pour récupérer la configuration sécurisée...');
      
      // Récupération de la configuration via l'Edge Function sécurisée
      const response = await fetch('/api/auth/secure-client-config');
      
      if (!response.ok) {
        console.error('Erreur HTTP lors de la récupération de la configuration:', 
                     response.status, response.statusText);
        
        let errorText = '';
        try {
          errorText = await response.text();
        } catch (e) {
          errorText = 'Impossible de lire la réponse';
        }
        
        console.error('Détails de l\'erreur:', errorText);
        
        initLock = false;
        isInitializing = false;
        initializationPromise = null;
        resolve(false);
        return;
      }
      
      const { anonKey } = await response.json();
      
      if (!anonKey) {
        console.error('Clé API non trouvée dans la réponse');
        initLock = false;
        isInitializing = false;
        initializationPromise = null;
        resolve(false);
        return;
      }
      
      // Réinitialise le client avec la clé récupérée de façon sécurisée
      // @ts-ignore - Nous manipulons directement le client pour des raisons de sécurité
      supabase.supabaseKey = anonKey;
      
      // Force le client à utiliser la nouvelle clé pour toutes les futures requêtes
      // @ts-ignore - Accès interne pour mise à jour sécurisée
      supabase.rest.headers['apikey'] = anonKey;
      
      // Configurations supplémentaires pour s'assurer que l'authentification fonctionne correctement
      // @ts-ignore - Accès interne pour mise à jour sécurisée
      if (supabase.auth && typeof supabase.auth.setAuth === 'function') {
        // @ts-ignore - Accès interne pour mise à jour sécurisée
        supabase.auth.setAuth(anonKey);
      }
      
      console.log('Client Supabase initialisé avec succès');
      
      // Test après initialisation
      try {
        const { data, error } = await supabase.auth.getSession();
        if (error) {
          console.warn('⚠️ Test post-initialisation: Erreur lors de la récupération de la session:', error);
        } else {
          console.log('✅ Test post-initialisation: Session récupérée avec succès');
        }
      } catch (e) {
        console.error('❌ Erreur lors du test post-initialisation:', e);
      }
      
      // Réinitialisation des compteurs de tentatives en cas de succès
      initAttempts = 0;
      
      initLock = false;
      isInitializing = false;
      resolve(true);
    } catch (error) {
      console.error('Erreur critique lors de l\'initialisation du client:', error);
      initLock = false;
      isInitializing = false;
      initializationPromise = null;
      resolve(false);
    }
  });
  
  return initializationPromise;
};

// Fonction asynchrone qui attend que le client soit initialisé avant d'exécuter une action
export const withInitializedClient = async <T>(action: () => Promise<T>): Promise<T> => {
  const success = await initializeSecureClient();
  
  if (!success) {
    console.warn('Tentative d\'opération avec un client non initialisé - réessai d\'initialisation');
    
    // Réinitialiser la promesse pour forcer une nouvelle tentative
    initializationPromise = null;
    
    // Nouvelle tentative d'initialisation
    const retrySuccess = await initializeSecureClient();
    
    if (!retrySuccess) {
      throw new Error('Impossible d\'initialiser le client Supabase après plusieurs tentatives');
    }
  }
  
  return action();
};

// Fonction pour nettoyer l'état d'authentification en cas de problème
export const cleanupAuthState = () => {
  // Supprimer toutes les clés liées à l'authentification Supabase
  Object.keys(localStorage).forEach((key) => {
    if (key.startsWith('supabase.auth.') || key.includes('sb-')) {
      localStorage.removeItem(key);
    }
  });
  
  // Essayer de réinitialiser le client
  initializationPromise = null;
  
  return initializeSecureClient();
};

// Note: Ce client démarre avec des permissions limitées jusqu'à l'initialisation complète
// Pour toute opération sensible, utilisez les Edge Functions
