
// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

// Configuration initiale avec des valeurs par défaut pour permettre l'initialisation immédiate
// Ces valeurs sont publiques et peuvent être incluses côté client sans risque
let supabaseUrl = "https://rdwqedmvzicerwotjseg.supabase.co";
let supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkd3FlZG12emljZXJ3b3Rqc2VnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMwNzg4MzEsImV4cCI6MjA1ODY1NDgzMX0.Ohle_vVvdoCvsObP9A_AdyM52XdzisIvHvH1D1a88zk";

// Créer le client avec les valeurs par défaut et les bonnes options d'authentification
export let supabase = createClient<Database>(
  supabaseUrl,
  supabaseAnonKey,
  {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: false // Disable auto detection of Auth tokens in URL
    }
  }
);

// Fonction pour initialiser le client Supabase
async function initializeSupabaseClient() {
  console.log("Initializing Supabase client...");
  try {
    // Récupérer la configuration depuis l'Edge Function
    const baseUrl = window.location.origin;
    const apiUrl = `${baseUrl}/api/get-public-config`;
    console.log("Fetching Supabase config from:", apiUrl);
    
    const response = await fetch(apiUrl, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Cache-Control': 'no-cache, no-store'
      }
    });
    
    if (!response.ok) {
      console.warn(`Failed to retrieve Supabase configuration: ${response.status} ${response.statusText}`);
      console.log("Using default configuration");
      return; // Continue with default values
    }
    
    let responseText;
    try {
      responseText = await response.text();
      console.log("Response received:", responseText.substring(0, 100) + "...");
      
      // Check if the response is HTML instead of JSON
      if (responseText.trim().startsWith('<!DOCTYPE html>') || 
          responseText.trim().startsWith('<html>')) {
        console.error("Received HTML instead of JSON. Check your Edge Function configuration.");
        throw new Error("Invalid response format: Expected JSON, got HTML");
      }
      
      const config = JSON.parse(responseText);
      console.log("Config parsed successfully:", config);
      
      if (!config?.supabaseUrl || !config?.supabaseAnonKey) {
        console.warn("Incomplete Supabase configuration:", config);
        return; // Continue with default values
      }
      
      // Recreate the client with the retrieved values
      supabaseUrl = config.supabaseUrl;
      supabaseAnonKey = config.supabaseAnonKey;
      
      supabase = createClient<Database>(
        supabaseUrl, 
        supabaseAnonKey, 
        {
          auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: false // Disable auto detection of Auth tokens in URL
          }
        }
      );
      
      console.log("Supabase client successfully initialized with config from Edge Function");
    } catch (parseError) {
      console.error("Error parsing configuration:", parseError);
      if (responseText) {
        console.log("Response received:", responseText.substring(0, 200) + "...");
      }
      return; // Continue with default values
    }
  } catch (error) {
    console.error("Error initializing Supabase client:", error);
    console.warn("Using default values for Supabase client");
  }
}

// Initialize the client on load
initializeSupabaseClient().catch(console.error);
